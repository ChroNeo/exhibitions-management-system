FROM node:20-alpine

ENV NODE_ENV=development \
    PNPM_HOME=/usr/local/share/pnpm \
    PNPM_STORE_DIR=/app/.pnpm-store

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@9 --activate \
 && pnpm config set store-dir ${PNPM_STORE_DIR} \
 && pnpm config set node-linker pnpm

# Copy workspace files
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/backend/package.json ./apps/backend/package.json

# Install dependencies
RUN pnpm --dir apps/backend install --frozen-lockfile

# Copy backend code
COPY apps/backend ./apps/backend

EXPOSE 3001
CMD ["pnpm", "--dir", "apps/backend", "dev"]
